---
status: pending
priority: p2
issue_id: "045"
tags: [code-review, security, error-handling, logging]
dependencies: []
---

# é”™è¯¯ä¿¡æ¯æ³„éœ²ä¿®å¤ - ç”Ÿäº§çŽ¯å¢ƒæ—¥å¿—è„±æ•

## é—®é¢˜é™ˆè¿°

åœ¨ `utils.js` çš„é”™è¯¯å¤„ç†å‡½æ•°ä¸­ï¼Œå­˜åœ¨é”™è¯¯ä¿¡æ¯æ³„éœ²é£Žé™©ã€‚å½“å‰çš„ `createErrorHandler` å‡½æ•°ä¼šåœ¨æŽ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­å¯èƒ½æš´éœ²å†…éƒ¨ç³»ç»ŸçŠ¶æ€ã€æ–‡ä»¶è·¯å¾„ã€å †æ ˆè·Ÿè¸ªç­‰æ•æ„Ÿä¿¡æ¯ã€‚

## å‘çŽ°ç»†èŠ‚

- **å‘çŽ°ä½ç½®**: `main/utils.js` ç¬¬138è¡Œ
- **å‘çŽ°æ¥æº**: compounding-engineering:security-sentinel ä»£ç†åˆ†æž
- **é£Žé™©è¯„çº§**: ðŸŸ¡ P2 - ä¸­ç­‰å®‰å…¨é£Žé™©

### å…·ä½“é£Žé™©ä»£ç 

```javascript
// utils.js:131-143
export const createErrorHandler = (context) => {
    return (error, fallback = null) => {
        console.error(`[${context}] é”™è¯¯:`, error);  // é£Žé™©ç‚¹
        if (fallback && typeof fallback === 'function') {
            return fallback();
        }
        return null;
    };
};
```

### é£Žé™©åœºæ™¯åˆ†æž

#### 1. ä¿¡æ¯æ³„éœ²ç±»åž‹
- **å †æ ˆè·Ÿè¸ª**: å¯èƒ½æš´éœ²ä»£ç ç»“æž„å’Œæ–‡ä»¶è·¯å¾„
- **é”™è¯¯å¯¹è±¡**: å¯èƒ½åŒ…å«å†…éƒ¨çŠ¶æ€ä¿¡æ¯
- **ä¸Šä¸‹æ–‡ä¿¡æ¯**: æš´éœ²å‡½æ•°è°ƒç”¨é“¾

#### 2. æ½œåœ¨å½±å“
- **å®‰å…¨ä¿¡æ¯**: æ”»å‡»è€…å¯èƒ½äº†è§£ç³»ç»Ÿå†…éƒ¨ç»“æž„
- **ä¸šåŠ¡é€»è¾‘**: å¯èƒ½æš´éœ²æ•°æ®å¤„ç†æµç¨‹
- **è°ƒè¯•ä¿¡æ¯**: å¸®åŠ©æ”»å‡»è€…æ‰¾åˆ°æ”»å‡»ç‚¹

#### 3. é£Žé™©è¯„ä¼°
- **å½“å‰çŽ¯å¢ƒ**: å¼€å‘çŽ¯å¢ƒé£Žé™©è¾ƒä½Ž
- **ç”Ÿäº§çŽ¯å¢ƒ**: ä¸­ç­‰é£Žé™©
- **ç”¨æˆ·çŽ¯å¢ƒ**: å¯èƒ½è¢«æ¶æ„ç”¨æˆ·åˆ©ç”¨

## æè®®çš„è§£å†³æ–¹æ¡ˆ

### é€‰é¡¹1: çŽ¯å¢ƒæ„ŸçŸ¥çš„é”™è¯¯å¤„ç†ï¼ˆæŽ¨èï¼‰

**å®žæ–½ç­–ç•¥**:
1. æ·»åŠ çŽ¯å¢ƒæ£€æµ‹æœºåˆ¶
2. ç”Ÿäº§çŽ¯å¢ƒåªè¾“å‡ºé”™è¯¯ç±»åž‹å’Œæ¶ˆæ¯
3. å¼€å‘çŽ¯å¢ƒä¿æŒè¯¦ç»†æ—¥å¿—
4. å¯é…ç½®çš„æ—¥å¿—çº§åˆ«

**ä¼˜åŠ¿**:
- å¹³è¡¡è°ƒè¯•éœ€æ±‚å’Œå®‰å…¨è¦æ±‚
- ä¸å½±å“å¼€å‘è°ƒè¯•æ•ˆçŽ‡
- ç¬¦åˆç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ

**åŠ£åŠ¿**:
- éœ€è¦å¢žåŠ çŽ¯å¢ƒæ£€æµ‹é€»è¾‘
- ç»´æŠ¤ä¸¤å¥—æ—¥å¿—æ ¼å¼

**å·¥ä½œé‡**: Small
**é£Žé™©**: Low

### é€‰é¡¹2: ç»Ÿä¸€é”™è¯¯è„±æ•

**å®žæ–½ç­–ç•¥**:
1. ç»Ÿä¸€ç®€åŒ–æ‰€æœ‰é”™è¯¯è¾“å‡º
2. åªä¿ç•™é”™è¯¯ç±»åž‹å’ŒåŸºæœ¬æ¶ˆæ¯
3. ç§»é™¤è¯¦ç»†çš„å †æ ˆè·Ÿè¸ª

**ä¼˜åŠ¿**:
- å®žçŽ°ç®€å•ï¼Œç»Ÿä¸€æ ‡å‡†
- å½»åº•æ¶ˆé™¤ä¿¡æ¯æ³„éœ²

**åŠ£åŠ¿**:
- å½±å“å¼€å‘è°ƒè¯•æ•ˆçŽ‡
- å¯èƒ½ä¸¢å¤±æœ‰ç”¨çš„è°ƒè¯•ä¿¡æ¯

**å·¥ä½œé‡**: Small
**é£Žé™©**: Low

## æŽ¨èè¡ŒåŠ¨

é‡‡ç”¨**é€‰é¡¹1**ï¼Œå®žæ–½çŽ¯å¢ƒæ„ŸçŸ¥çš„é”™è¯¯å¤„ç†ï¼Œåœ¨ä¿æŒå¼€å‘æ•ˆçŽ‡çš„åŒæ—¶ç¡®ä¿ç”Ÿäº§å®‰å…¨ã€‚

## æŠ€æœ¯å®žæ–½ç»†èŠ‚

### çŽ¯å¢ƒæ„ŸçŸ¥é”™è¯¯å¤„ç†å‡½æ•°

```javascript
// utils.js ä¸­çš„æ”¹è¿›å®žçŽ°
export const isProduction = () => {
    return process?.env?.NODE_ENV === 'production' ||
           window?.location?.hostname !== 'localhost' &&
           window?.location?.hostname !== '127.0.0.1';
};

export const createErrorHandler = (context, enableVerboseLogs = !isProduction()) => {
    return (error, fallback = null) => {
        if (enableVerboseLogs) {
            // å¼€å‘çŽ¯å¢ƒï¼šè¯¦ç»†é”™è¯¯ä¿¡æ¯
            console.error(`[${context}] é”™è¯¯:`, error);
            if (error.stack) {
                console.error(`[${context}] å †æ ˆ:`, error.stack);
            }
        } else {
            // ç”Ÿäº§çŽ¯å¢ƒï¼šè„±æ•é”™è¯¯ä¿¡æ¯
            const safeMessage = sanitizeErrorMessage(error);
            console.error(`[${context}] é”™è¯¯:`, safeMessage);
        }

        if (fallback && typeof fallback === 'function') {
            return fallback();
        }
        return null;
    };
};

export const sanitizeErrorMessage = (error) => {
    if (!error) return 'æœªçŸ¥é”™è¯¯';

    // åªä¿ç•™é”™è¯¯ç±»åž‹å’ŒåŸºæœ¬æ¶ˆæ¯
    if (typeof error === 'string') {
        return error.substring(0, 200); // é™åˆ¶é•¿åº¦
    }

    if (error instanceof Error) {
        return {
            type: error.constructor.name,
            message: error.message?.substring(0, 200) || 'å‘ç”Ÿé”™è¯¯'
        };
    }

    if (typeof error === 'object') {
        return {
            type: 'ObjectError',
            message: 'å¯¹è±¡å¤„ç†é”™è¯¯'
        };
    }

    return 'æœªçŸ¥é”™è¯¯ç±»åž‹';
};
```

### ä½¿ç”¨ç¤ºä¾‹

```javascript
// å¼€å‘çŽ¯å¢ƒ - è¯¦ç»†æ—¥å¿—
const gameErrorHandler = createErrorHandler('GameModule');
// è¾“å‡º: [GameModule] é”™è¯¯: TypeError: Cannot read property 'x' of undefined { stack: "..." }

// ç”Ÿäº§çŽ¯å¢ƒ - è„±æ•æ—¥å¿—
const productionErrorHandler = createErrorHandler('GameModule', false);
// è¾“å‡º: [GameModule] é”™è¯¯: { type: "TypeError", message: "Cannot read property..." }
```

### é…ç½®åŒ–æ—¥å¿—çº§åˆ«

```javascript
// æ·»åŠ æ—¥å¿—çº§åˆ«æŽ§åˆ¶
export const LOG_LEVELS = {
    ERROR: 0,
    WARN: 1,
    INFO: 2,
    DEBUG: 3
};

export const getCurrentLogLevel = () => {
    if (isProduction()) return LOG_LEVELS.ERROR;
    return LOG_LEVELS.DEBUG; // å¼€å‘çŽ¯å¢ƒæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
};

export const safeLog = (level, context, message, data) => {
    if (level <= getCurrentLogLevel()) {
        const sanitizedData = isProduction() ? sanitizeErrorMessage(data) : data;
        console.log(`[${context}] ${message}:`, sanitizedData);
    }
};
```

## å®žæ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šå®žçŽ°çŽ¯å¢ƒæ£€æµ‹ï¼ˆ1å°æ—¶ï¼‰
1. æ·»åŠ  `isProduction()` å‡½æ•°
2. æ·»åŠ  `sanitizeErrorMessage()` å‡½æ•°
3. æ›´æ–° `createErrorHandler()` å‡½æ•°

### ç¬¬äºŒé˜¶æ®µï¼šæ›´æ–°é”™è¯¯è°ƒç”¨ï¼ˆ2å°æ—¶ï¼‰
1. æ£€æŸ¥æ‰€æœ‰ `createErrorHandler` çš„ä½¿ç”¨
2. æ ¹æ®éœ€è¦è°ƒæ•´æ—¥å¿—è¯¦ç»†ç¨‹åº¦
3. æ·»åŠ é”™è¯¯ç±»åž‹åˆ†ç±»

### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰
1. æµ‹è¯•å¼€å‘çŽ¯å¢ƒæ—¥å¿—è¾“å‡º
2. æµ‹è¯•ç”Ÿäº§çŽ¯å¢ƒæ—¥å¿—è„±æ•
3. éªŒè¯é”™è¯¯å¤„ç†åŠŸèƒ½æ­£å¸¸

## å—å½±å“çš„æ–‡ä»¶

- `main/utils.js` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `main/chess.js` - å¯èƒ½éœ€è¦æ›´æ–°é”™è¯¯å¤„ç†è°ƒç”¨
- `test/tests/` - éœ€è¦æ›´æ–°æµ‹è¯•ç”¨ä¾‹
- å…¶ä»–ä½¿ç”¨é”™è¯¯å¤„ç†çš„æ¨¡å—

## ç›¸å…³ç»„ä»¶

- é”™è¯¯å¤„ç†æ¨¡å—
- æ—¥å¿—è®°å½•ç³»ç»Ÿ
- è°ƒè¯•å·¥å…·

## æ•°æ®åº“æ›´æ”¹

æ— 

## èµ„æº

- **ä»£ç å®¡æŸ¥æ¥æº**: compounding-engineering:security-sentinel
- **å®‰å…¨å‚è€ƒ**: OWASPé”™è¯¯å¤„ç†æœ€ä½³å®žè·µ
- **ç›¸å…³å‘çŽ°**:
  - 043 DOMå®‰å…¨æ¼æ´ž
  - 044 è¿‡åº¦å·¥ç¨‹åŒ–é‡æž„

## éªŒæ”¶æ ‡å‡†

- [ ] ç”Ÿäº§çŽ¯å¢ƒé”™è¯¯ä¿¡æ¯å·²è„±æ•
- [ ] å¼€å‘çŽ¯å¢ƒä¿æŒè¯¦ç»†è°ƒè¯•ä¿¡æ¯
- [ ] æ‰€æœ‰é”™è¯¯å¤„ç†åŠŸèƒ½æ­£å¸¸
- [ ] é€šè¿‡æ‰€æœ‰214ä¸ªæµ‹è¯•ç”¨ä¾‹
- [ ] æ€§èƒ½æ— æ˜Žæ˜¾å½±å“ï¼ˆ<1%å¼€é”€ï¼‰
- [ ] æ—¥å¿—è¾“å‡ºæ ¼å¼ç»Ÿä¸€è§„èŒƒ

## å·¥ä½œæ—¥å¿—

### 2024-10-11 - ä¿¡æ¯æ³„éœ²å‘çŽ°
**æ‰§è¡Œè€…**: Claude Code Review System
**æ“ä½œ**:
- security-sentinel ä»£ç†è¯†åˆ«å‡ºé”™è¯¯ä¿¡æ¯æ³„éœ²é£Žé™©
- åˆ†æžäº†ç”Ÿäº§çŽ¯å¢ƒvså¼€å‘çŽ¯å¢ƒçš„æ—¥å¿—éœ€æ±‚å·®å¼‚
- è¯„ä¼°ä¸ºP2ä¼˜å…ˆçº§å®‰å…¨é—®é¢˜

**æŠ€æœ¯å†³ç­–**:
- é€‰æ‹©çŽ¯å¢ƒæ„ŸçŸ¥æ–¹æ¡ˆè€Œéžä¸€åˆ€åˆ‡
- ä¿æŒå¼€å‘æ•ˆçŽ‡çš„åŒæ—¶ç¡®ä¿ç”Ÿäº§å®‰å…¨
- è®¾è®¡å¯é…ç½®çš„æ—¥å¿—çº§åˆ«ç³»ç»Ÿ

**å®‰å…¨è€ƒé‡**:
- ç”Ÿäº§çŽ¯å¢ƒä¸æš´éœ²å†…éƒ¨å †æ ˆä¿¡æ¯
- é”™è¯¯æ¶ˆæ¯é•¿åº¦é™åˆ¶
- é”™è¯¯å¯¹è±¡ç»“æž„æ ‡å‡†åŒ–

## æ³¨æ„äº‹é¡¹

**å…³é”®è€ƒè™‘**:
- ç¡®ä¿ä¸å½±å“çŽ°æœ‰é”™è¯¯å¤„ç†é€»è¾‘
- ä¿æŒè°ƒè¯•ä¿¡æ¯çš„å¯ç”¨æ€§
- å»ºç«‹æ¸…æ™°çš„æ—¥å¿—è®°å½•æ ‡å‡†

**é£Žé™©ç¼“è§£**:
- åˆ†é˜¶æ®µå®žæ–½ï¼Œç¡®ä¿åŠŸèƒ½ç¨³å®š
- å……åˆ†æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯
- å»ºç«‹æ—¥å¿—å®¡æŸ¥æµç¨‹

**åŽç»­æ”¹è¿›**:
- è€ƒè™‘æ·»åŠ è¿œç¨‹æ—¥å¿—æ”¶é›†
- å®žçŽ°é”™è¯¯ç›‘æŽ§å’Œå‘Šè­¦
- å»ºç«‹é”™è¯¯ç»Ÿè®¡å’Œåˆ†æž

**æ¥æº**: å…¨é¢ä»£ç å®¡æŸ¥ç³»ç»Ÿ
**å®¡æŸ¥å‘½ä»¤**: /compounding-engineering:review
**å®¡æŸ¥æ—¥æœŸ**: 2024-10-11