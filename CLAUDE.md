# CLAUDE.md

本文件为 Claude Code（claude.ai/code）在处理本仓库代码时提供指导。

## 项目概述

中国象棋（Xiangqi）游戏 - 功能完整的浏览器端实现，包含棋谱演示、步骤导航和智能解析功能。

**技术栈**: 原生 HTML/CSS/JavaScript，无外部依赖
**架构**: ES6 类设计 + 事件驱动 + 模块化测试

## 核心文件职责

### 🎮 main/ - 游戏核心模块
- **`index.html`** - 游戏UI结构，内嵌棋谱面板交互逻辑
- **`chess.js`** (~1872行) - 核心游戏引擎 `XiangqiGame` 类
- **`chess-notation-parser.js`** (~523行) - 标准棋谱记谱法解析器
- **`style.css`** - 完整响应式样式系统
- **`audio-manager.js`** - Web Audio API 木质音效系统
- **`classic_openings.json`** - 经典开局数据（传统格式）
- **`standard-openings.json`** - 标准格式棋谱数据

### 🧪 test/ - 测试模块
- **Jest + JSDOM** - 完整的浏览器环境模拟测试
- **测试覆盖**: 棋盘初始化、移动规则、将军检测、经典棋局、音频系统

## 关键系统架构

### 1. 游戏状态管理
```javascript
// 核心状态
currentPlayer: 'red'|'black'      // 当前回合
gamePhase: 'playing'|'demonstration' // 游戏阶段
pieces: Array                      // 棋子数组
moveHistory: Array                  // 移动历史 {pieceType, pieceColor, from, to, notation}
```

### 2. 棋谱解析系统
```javascript
// ChessNotationParser 类
- 标准记谱法解析: "炮二平五", "马二进三"
- 红黑坐标差异处理
- 路码系统转换 (红方: 1路=右到左, 黑方: 1路=左到右)
```

### 3. 步骤导航系统
- **`playToStep(index)`** - 跳转到指定步骤
- **`updateRecordStepsDisplay()`** - 渲染可点击步骤列表
- 支持步骤高亮和视觉反馈

## 开发原则和约束

### 🚫 绝对禁止
1. **文件位置错误**
   - 永远不在 `main/` 创建测试文件
   - 永远不在根目录创建 `md` 文档（用户要求除外）
   - 测试文件必须放在 `test/` 目录

2. **功能破坏**
   - 任何修改必须保证现有功能正常
   - 破坏功能时立即回滚
   - 重大修改先创建测试用例

3. **架构偏离**
   - 不创建独立的脱离主系统的模块
   - 使用现有数据格式和API
   - 优先修改现有文件而非新建

### ✅ 强制要求
1. **测试验收**: 所有更改 `cd test && npm test`
2. **浏览器验证**: 无控制台错误，手动测试通过
3. **文档同步**: 重大功能更新 CLAUDE.md
4. **文件清理**: 开发完成后清理临时文件

## 开发工作流

### 常见任务对应命令
```bash
# 语法检查
node -c main/chess.js

# 运行测试套件
cd test && npm test

# 浏览器测试 (推荐)
python -m http.server 8000
# 然后访问 http://localhost:8000/main/index.html

# 运行爬虫
cd scraper && node complete-scraper.js
```

### 修改优先级
1. **P0** - 核心游戏功能（移动、规则）
2. **P1** - 棋谱播放功能（全局棋谱、着法显示）
3. **P2** - 步骤导航功能（点击跳转、高亮）
4. **P3** - 解析增强功能（新格式支持）
5. **P4** - 爬虫和数据功能

## 重要业务规则

### 棋盘坐标系统
- **9×10网格**: 行(0-9), 列(0-8)
- **红方视角**: 第9行 = 底部，第0行 = 顶部
- **黑方视角**: 第0行 = 底部，第9行 = 顶部

### 关键游戏规则
- **将帅不能照面**: 直接中间无棋子时失败
- **移动限制**: 马蹩腿、象賽象眼、士将不出宫
- **过河规则**: 象不能过河，兵过河可横移
- **将军检测**: 所有移动不能让自己被将军

### 棋谱解析关键点
- **红方路码**: 从右到左数 (1路=8列, 2路=7列...)
- **黑方路码**: 从左到右数 (1路=0列, 2路=1列...)
- **"二路马"**: 红方右边马 (列7)

## 测试要求清单

### 每次提交前验证
- [ ] 棋子移动正常，无重复棋子
- [ ] 全局棋谱面板正常显示
- [ ] 棋谱步骤列表点击跳转正常
- [ ] 播放控制功能正常
- [ ] 步骤高亮效果正确
- [ ] 所有测试用例通过 (`npm test`)
- [ ] 浏览器无控制台错误

### 修复回滚策略
1. 发现功能破坏立即停止开发
2. 回滚到上一个工作版本
3. 分析问题，重保守方案
4. 增量式集成，逐一验证

## 特殊开发说明

### 棋谱相关开发
- **数据格式**: 必须兼容现有 `classic_openings.json` 和 `standard-openings.json`
- **解析器**: 新增格式需要在 `ChessNotationParser` 中实现
- **播放系统**: 使用 `loadAndPlayClassicGame*` 方法体系
- **步骤导航**: 基于 `playToStep` 和 `updateRecordStepsDisplay`

### 音频系统开发
- **环境处理**: 自动优雅跳过测试环境
- **API**: AudioContext 可用性检测
- **音效类型**: pieceMove, pieceCapture, pieceSelect, check, victory

### CSS 样式开发
- **响应式优先**: 移动端适应性
- **模块化**: 按功能区域组织样式
- **状态样式**: 使用类名切换而非直接样式修改

---

**记住**: 这是一个无构建步骤的独立应用，更改可直接在浏览器中验证。优先保护现有功能，渐进式开发新特性。